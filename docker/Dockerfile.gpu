# Multi-stage GPU-enabled Dockerfile for MM-HIE backend

# === Builder stage ===
FROM pytorch/pytorch:2.1.0-cuda11.8-cudnn8-runtime AS builder

WORKDIR /app

# Install system deps (if any are needed by Python packages)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Create dedicated virtualenv and install Python deps
COPY mm-hie-backend/requirements.txt ./
RUN python -m venv /opt/venv \
    && /opt/venv/bin/pip install --upgrade pip \
    && /opt/venv/bin/pip install --no-cache-dir -r requirements.txt

# Copy backend source
COPY mm-hie-backend/ ./

# Optional: run tests here in CI/CD, e.g.
# RUN /opt/venv/bin/pytest


# === Runtime stage ===
FROM pytorch/pytorch:2.1.0-cuda11.8-cudnn8-runtime

WORKDIR /app

# Copy virtualenv from builder
COPY --from=builder /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH" \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1

# Copy backend code (kept separate from venv to allow rebuild caching)
COPY mm-hie-backend/ ./

# Expose FastAPI port
EXPOSE 8000

# Healthcheck: rely on FastAPI docs endpoint
HEALTHCHECK --interval=30s --timeout=5s --retries=3 CMD curl -f http://localhost:8000/docs || exit 1

# Default command: run uvicorn with reasonable production flags
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers", "--forwarded-allow-ips", "*"]
